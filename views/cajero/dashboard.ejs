<%- include('../partials/header') %>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cash-register text-warning"></i> Caja</h1>
        <a href="/cajero" class="btn btn-outline-dark"><i class="fas fa-sync"></i> Actualizar</a>
    </div>

    <%- include('../partials/messages') %>

    <div class="row">
        <% if (pedidos.length === 0) { %>
            <div class="col-12 text-center py-5 text-muted bg-light rounded shadow-sm">
                <i class="fas fa-check-circle fa-4x mb-3 text-success"></i>
                <h3>No hay mesas pendientes de cobro</h3>
            </div>
        <% } else { %>
            <% pedidos.forEach(pedido => { %>
                
                <!-- Cálculo del Total -->
                <% 
                    let totalPedido = 0;
                    let itemsCount = 0;
                    pedido.items.forEach(item => {
                        itemsCount++;
                        totalPedido += parseFloat(item.precio_unitario || 0);
                        if (item.componentes) {
                            item.componentes.forEach(comp => {
                                totalPedido += parseFloat(comp.precio_adicional || 0);
                            });
                        }
                    });
                %>

                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card border-warning shadow h-100">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 fw-bold"><i class="fas fa-chair"></i> Mesa <%= pedido.mesa.numero %></h4>
                            <span class="badge bg-dark">#<%= pedido.id %></span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="text-center mb-4">
                                <h6 class="text-muted">Total a Pagar</h6>
                                <h1 class="display-4 fw-bold text-success">$<%= totalPedido.toLocaleString('es-CO') %></h1>
                                <span class="badge bg-secondary"><%= itemsCount %> items</span>
                            </div>

                            <div class="mt-auto">
                                <!-- Botón que abre el Modal -->
                                <button type="button" class="btn btn-success w-100 btn-lg py-3" data-bs-toggle="modal" data-bs-target="#cobrarModal<%= pedido.id %>">
                                    <i class="fas fa-hand-holding-usd me-2"></i> PROCESAR PAGO
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODAL DE COBRO PARA ESTE PEDIDO -->
                <div class="modal fade" id="cobrarModal<%= pedido.id %>" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Cobrar Mesa <%= pedido.mesa.numero %></h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form action="/cajero/pedido/<%= pedido.id %>/estado" method="POST"> <!-- Ajusta la ruta según cocinaController o cajeroController -->
                                <!-- NOTA: En el controller te puse 'cobrarPedido', la ruta debería ser /cajero/cobrar/:pedidoId -->
                                <!-- Ajuste aquí: -->
                            </form>
                            
                            <!-- CORRECCIÓN DEL FORMULARIO -->
                            <form action="/cajero/pedido/<%= pedido.id %>/estado" method="POST" id="form-cobro-<%= pedido.id %>">
                                <!-- Espera, en el código de rutas de cajero normalmente es /cajero/cobrar/:id. Ajustemos el action: -->
                            </form>
                            
                            <form action="/cajero/pedido/<%= pedido.id %>/estado" method="POST" class="d-none"></form> <!-- Dummy -->

                            <form action="/cajero/cobrar/<%= pedido.id %>" method="POST">
                                <div class="modal-body text-start">
                                    <h3 class="text-center text-success fw-bold mb-4">$<%= totalPedido.toLocaleString('es-CO') %></h3>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Método de Pago:</label>
                                        
                                        <div class="form-check mb-2 card p-2 border-success bg-light">
                                            <input class="form-check-input" type="radio" name="tipo_pago" id="pago_efectivo_<%= pedido.id %>" value="efectivo" checked onchange="toggleEmpresa(this, <%= pedido.id %>)">
                                            <label class="form-check-label w-100" for="pago_efectivo_<%= pedido.id %>">
                                                <i class="fas fa-money-bill-wave text-success me-2"></i> Efectivo / Transferencia
                                            </label>
                                        </div>

                                        <div class="form-check card p-2 border-primary bg-light">
                                            <input class="form-check-input" type="radio" name="tipo_pago" id="pago_credito_<%= pedido.id %>" value="credito" onchange="toggleEmpresa(this, <%= pedido.id %>)">
                                            <label class="form-check-label w-100" for="pago_credito_<%= pedido.id %>">
                                                <i class="fas fa-building text-primary me-2"></i> Crédito Empresa (Fiado)
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Selector de Empresa (Oculto) -->
                                    <div id="div_empresa_<%= pedido.id %>" class="mb-3 d-none animate__animated animate__fadeIn">
                                        <label class="form-label fw-bold">Seleccionar Empresa:</label>
                                        <select name="empresa_id" class="form-select border-primary">
                                            <option value="">-- Seleccione --</option>
                                            <% empresas.forEach(emp => { %>
                                                <option value="<%= emp.id %>"><%= emp.nombre %></option>
                                            <% }); %>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-success fw-bold">CONFIRMAR PAGO</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } %>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    socket.on('mesa_por_cobrar', () => location.reload());

    function toggleEmpresa(radio, id) {
        const div = document.getElementById('div_empresa_' + id);
        const select = div.querySelector('select');
        if (radio.value === 'credito') {
            div.classList.remove('d-none');
            select.required = true;
        } else {
            div.classList.add('d-none');
            select.required = false;
            select.value = "";
        }
    }
</script>

<%- include('../partials/footer') %>