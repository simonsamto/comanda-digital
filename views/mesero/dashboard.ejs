<%- include('../partials/header') %>

<style>
    /* Contenedor del Mapa (Igual al admin pero sin grid de fondo) */
    #mapa-restaurante {
        width: 100%;
        height: 600px; /* Asegúrate que coincida o sea responsivo */
        background-color: #fff;
        border: 1px solid #ddd;
        position: relative;
        overflow: auto; /* Scroll si es muy grande */
        border-radius: 8px;
        box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }

    .mesa-real {
        position: absolute;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        transition: transform 0.2s, box-shadow 0.2s;
        text-decoration: none !important;
        color: white;
    }
    .mesa-real:hover { transform: scale(1.05); z-index: 10; }
    
    /* Colores por Estado */
    .mesa-libre { background-color: #198754; border: 2px solid #146c43; } /* Verde */
    .mesa-ocupada { background-color: #dc3545; border: 2px solid #b02a37; } /* Rojo */
    .mesa-recoger { 
        background-color: #0dcaf0; border: 2px solid #0aa2c0; color: black;
        animation: pulse-blue 2s infinite; 
    }
    .mesa-caja { background-color: #ffc107; border: 2px solid #cc9a06; color: black; }

    .mesa-numero { font-size: 1.5rem; font-weight: bold; line-height: 1; }
    .mesa-estado { font-size: 0.7rem; text-transform: uppercase; margin-top: 5px; }

    @keyframes pulse-blue {
        0% { box-shadow: 0 0 0 0 rgba(13, 202, 240, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(13, 202, 240, 0); }
        100% { box-shadow: 0 0 0 0 rgba(13, 202, 240, 0); }
    }
</style>

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0"><i class="fas fa-map"></i> Salón</h2>
        <div>
            <span class="badge bg-success me-1">Libre</span>
            <span class="badge bg-danger me-1">Ocupado</span>
            <span class="badge bg-info text-dark me-1">Recoger</span>
            <span class="badge bg-warning text-dark">Caja</span>
        </div>
    </div>

    <!-- EL MAPA VISUAL -->
    <div id="mapa-restaurante">
        <% mesas.forEach(mesa => { %>
            <% 
                let estadoClass = 'mesa-libre';
                let link = `/mesero/mesa/${mesa.id}/clientes`; // Link por defecto
                let textoEstado = 'Libre';
                let formHTML = ''; // Para el botón de "Recoger"

                if (mesa.estado === 'ocupado') {
                    estadoClass = 'mesa-ocupada';
                    textoEstado = 'Ocupada';
                    link = '#'; // Bloqueado
                } else if (mesa.estado === 'para_recoger') {
                    estadoClass = 'mesa-recoger';
                    textoEstado = '¡RECOGER!';
                    // Formulario invisible que cubre la mesa para hacer el POST
                    formHTML = `
                        <form action="/mesero/entregar-pedido/${mesa.id}" method="POST" style="width:100%; height:100%; position:absolute; top:0; left:0;">
                            <button type="submit" style="width:100%; height:100%; opacity:0; cursor:pointer;" onclick="return confirm('¿Entregar pedido?');"></button>
                        </form>
                    `;
                } else if (mesa.estado === 'por_cobrar') {
                    estadoClass = 'mesa-caja';
                    textoEstado = 'Caja';
                    link = '#'; // Bloqueado
                }
            %>

            <!-- DIBUJO DE LA MESA -->
            <div class="mesa-real <%= estadoClass %>" 
                 style="left: <%= mesa.pos_x %>px; top: <%= mesa.pos_y %>px; width: <%= mesa.ancho %>px; height: <%= mesa.alto %>px;">
                
                <% if (mesa.estado === 'para_recoger') { %>
                    <%- formHTML %>
                <% } else if (link !== '#') { %>
                    <a href="<%= link %>" style="position:absolute; width:100%; height:100%;"></a>
                <% } %>

                <div class="mesa-numero"><%= mesa.numero %></div>
                <div class="mesa-estado"><%= textoEstado %></div>
            </div>

        <% }); %>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    socket.on('pedido_listo_para_recoger', () => location.reload());
    socket.on('mesa_liberada', () => location.reload()); 
</script>

<%- include('../partials/footer') %>