<%- include('../partials/header') %>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Mapa de Mesas</h1>
            <div>
                <!-- Puedes a√±adir un bot√≥n de actualizar o algo m√°s aqu√≠ si quieres -->
            </div>
        </div>

        <% if (!mesas || mesas.length===0) { %>
            <div class="alert alert-warning" role="alert">
                No hay mesas configuradas en el sistema. Por favor, contacte al administrador.
            </div>
            <% } else { %>
                <div class="row">
                    <% mesas.forEach(mesa=> { %>
                        <div class="col-6 col-md-3 col-lg-2 mb-4">
                            <!-- Cada tarjeta de mesa abre el modal -->
                            <a href="#" class="text-decoration-none text-dark card-mesa-link"
                                data-mesa-id="<%= mesa.id %>" data-mesa-numero="<%= mesa.numero %>"
                                data-mesa-capacidad="<%= mesa.capacidad %>">
                                <div class="card h-100 text-center shadow-sm card-mesa 
                                    <%= mesa.estado === 'libre' ? '' : 
                                       mesa.estado === 'en_cocina' ? 'bg-danger text-white' : 
                                       mesa.estado === 'elaborado' ? 'bg-warning text-dark' : 
                                       mesa.estado === 'entregado' ? 'bg-primary text-white' : '' %>">
                                    <div class="card-body d-flex flex-column justify-content-center">
                                        <i class="fas fa-utensils fa-3x mb-2"></i>
                                        <h5 class="card-title mb-0">Mesa</h5>
                                        <p class="card-text display-4 fw-bold">
                                            <%= mesa.numero %>
                                        </p>
                                        <small class="text-uppercase fw-bold mt-2">
                                            <%= mesa.estado==='libre' ? 'Disponible' : mesa.estado==='en_cocina'
                                                ? 'En Cocina' : mesa.estado==='elaborado' ? 'Listo para Servir' :
                                                mesa.estado==='entregado' ? 'Comiendo' : mesa.estado %>
                                        </small>
                                    </div>
                                    <% if (mesa.estado==='libre' ) { %>
                                        <div class="card-footer bg-success text-white">
                                            Disponible
                                        </div>
                                        <% } %>
                                </div>
                            </a>
                        </div>
                        <% }); %>
                </div>
                <% } %>
    </div>

    <style>
        .card-mesa {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card-mesa:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
    </style>

    <%- include('../partials/footer') %>

        <!-- Modal para Seleccionar Cantidad de Comensales -->
        <div class="modal fade" id="modalComensales" tabindex="-1" aria-labelledby="modalComensalesLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalComensalesLabel">N√∫mero de Comensales</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Ingrese la cantidad de personas para la <span id="modalMesaNumero" class="fw-bold"></span>.
                        </p>
                        <p class="text-muted small">Capacidad m√°xima: <span id="modalMesaCapacidad"></span></p>
                        <div class="form-group">
                            <label for="cantidadClientesInput" class="form-label">Cantidad de Personas:</label>
                            <input type="number" class="form-control form-control-lg text-center"
                                id="cantidadClientesInput" min="1" value="1">
                            <div class="invalid-feedback">
                                La cantidad no puede exceder la capacidad de la mesa.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="btnContinuarPedido">Continuar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Confirmar Entrega -->
        <div class="modal fade" id="modalEntrega" tabindex="-1" aria-labelledby="modalEntregaLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title text-dark" id="modalEntregaLabel">¬°Pedido Listo!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <i class="fas fa-concierge-bell fa-4x text-warning mb-3"></i>
                        <p class="lead">El pedido de la <span id="modalEntregaMesa" class="fw-bold"></span> est√° listo.
                        </p>
                        <p>¬øDeseas marcarlo como <strong>ENTREGADO</strong>?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form id="formEntrega" method="POST" action="">
                            <button type="submit" class="btn btn-primary">‚úÖ S√≠, Entregar Pedido</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Modal Comensales
                const modalComensalesEl = document.getElementById('modalComensales');
                const modalComensales = new bootstrap.Modal(modalComensalesEl);
                const inputCantidad = document.getElementById('cantidadClientesInput');
                const btnContinuar = document.getElementById('btnContinuarPedido');
                const spanMesaNumero = document.getElementById('modalMesaNumero');
                const spanMesaCapacidad = document.getElementById('modalMesaCapacidad');

                // Modal Entrega
                const modalEntregaEl = document.getElementById('modalEntrega');
                const modalEntrega = new bootstrap.Modal(modalEntregaEl);
                const spanEntregaMesa = document.getElementById('modalEntregaMesa');
                const formEntrega = document.getElementById('formEntrega');

                let currentMesaId = null;
                let currentCapacidad = 0;

                // Interceptar clics en las tarjetas de mesa
                document.querySelectorAll('.card-mesa-link').forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();

                        // Obtener datos de la mesa
                        currentMesaId = this.dataset.mesaId;
                        const mesaNumero = this.dataset.mesaNumero;
                        currentCapacidad = parseInt(this.dataset.mesaCapacidad);

                        // Determinar estado basado en las clases
                        const card = this.querySelector('.card-mesa');
                        let estado = 'libre';
                        if (card.classList.contains('bg-danger')) estado = 'en_cocina';
                        if (card.classList.contains('bg-warning')) estado = 'elaborado';
                        if (card.classList.contains('bg-primary')) estado = 'entregado';

                        if (estado === 'libre') {
                            // Flujo Normal: Pedir Comensales
                            spanMesaNumero.textContent = `Mesa ${mesaNumero}`;
                            spanMesaCapacidad.textContent = currentCapacidad;
                            inputCantidad.max = currentCapacidad;
                            inputCantidad.value = 1;
                            inputCantidad.classList.remove('is-invalid');
                            modalComensales.show();

                        } else if (estado === 'elaborado') {
                            // Flujo Entrega: Confirmar que se lleva la comida
                            spanEntregaMesa.textContent = `Mesa ${mesaNumero}`;
                            formEntrega.action = `/mesero/entregar-pedido/${currentMesaId}`;
                            modalEntrega.show();

                        } else if (estado === 'en_cocina') {
                            alert(`La Mesa ${mesaNumero} est√° esperando su comida. üïí`);
                        } else if (estado === 'entregado') {
                            alert(`La Mesa ${mesaNumero} est√° comiendo. üçΩÔ∏è`);
                        }
                    });
                });

                // Validar y redirigir al continuar (Comensales)
                btnContinuar.addEventListener('click', function () {
                    const cantidad = parseInt(inputCantidad.value);

                    if (cantidad < 1 || cantidad > currentCapacidad) {
                        inputCantidad.classList.add('is-invalid');
                        return;
                    }

                    if (currentMesaId) {
                        window.location.href = `/mesero/tomar-pedido/${currentMesaId}?cantidadClientes=${cantidad}`;
                    }
                });

                // Permitir presionar Enter en el input
                inputCantidad.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        btnContinuar.click();
                    }
                });
            });
        </script>